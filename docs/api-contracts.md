# Контракты взаимодействия между тулами или флоу: REST JSON (tools, flow Contracts Guide)

Документ описывает единые правила проектирования и эволюции REST JSON контрактов между n8n-флоу.

 ## TL;DR чеклист
  - [ ] Версионирование и пути: `/api/v{major}/{businessFlow}/{tool}/{action}` (например, `/lead-routing/hubspot-sync/v1/create-export`); все сегменты в kebab-case; минорные изменения — back‑compat.
  - [ ] Корреляция: обязательный `X-Request-Id` (если нет — генерируйте), прокидывайте в заголовки ответов, поле `meta.requestId` в теле ответа и логи.
  - [ ] Идемпотентность без хранения: используйте `PUT /api/v1/{businessFlow}/{tool}/<resource>/{deterministicId}` или повторяемые операции; ретраи `POST` не поддерживаются.
  - [ ] Форматы: ISO 8601 UTC для дат, деньги в minor units (cents), большие числа — строки.
  - [ ] Именование полей: все поля в JSON должны быть в формате pascalCase (`userId`, `firstName`).
  - [ ] Пагинация: cursor-based (`nextPageToken`), лимит по умолчанию и максимум; без неограниченных выборок.
  - [ ] Модель: tool-to-tool запрос–ответ; длительные операции через 202 + jobId.

 ## 1. Область и цели
  - Стандартизировать взаимодействие между флоу разных тулов через REST JSON.

 ## 2. Модель взаимодействия: tool-to-tool (запрос–ответ)
 - Синхронный запрос–ответ по умолчанию: вызов флоу-тула другим флоу-тула через HTTP(S) REST JSON.
 - Длительные операции: немедленный ответ `202 Accepted` с `jobId` и последующий `GET /api/v1/{businessFlow}/{tool}/jobs/{jobId}` (статус) и/или `.../download`.
 - Соединение не удерживается длительно; нет WebSocket/long-poll — только стандартные HTTP-запросы.
 - Заголовки и контракты — как в этом документе (JSON, `X-Request-Id`, таймауты/ретраи, безопасность).
  - 403 — недостаточно прав (FORBIDDEN)
  - 404 — не найдено (NOT_FOUND)
  - 409 — конфликт состояния/идентификатора (CONFLICT)
   - 412 — нарушено предусловие ETag/If-Match (PRECONDITION_FAILED)
   - 422 — бизнес-валидация не пройдена (VALIDATION_ERROR)
   - 429 — превышены лимиты (RATE_LIMITED)
   - 500 — внутренняя ошибка (INTERNAL_ERROR)
   - 502 — ошибка внешней зависимости (UPSTREAM_ERROR)

## 3. Структура пути и правила именования

### 3.1 Шаблон пути
- **Шаблон**: `/api/v{major}/{businessFlow}/{tool}/{action}`
- **Назначение**: Создание стабильного, самоописательного пространства имен, группирующего эндпоинты по бизнес-процессу и конкретному инструменту в рамках этого процесса.
- **Стиль именования**: Все сегменты пути (кроме версии) должны быть в kebab-case (слова через дефис, в нижнем регистре).

### 3.2 Компоненты пути
- **businessFlow**: kebab-case, стабильное название бизнес-домена или процесса.
  - Примеры: `lead-routing`, `data-enrichment`, `billing-reconciliation`.
- **tool**: kebab-case, алиас инструмента в рамках бизнес-процесса (не обязательно название вендорского продукта).
  - Примеры: `hubspot-sync`, `clearbit-enricher`, `stripe-gateway`.
- **v{major}**: Мажорная версия API с префиксом `v`.
  - Примеры: `v1`, `v2`.
- **action**: kebab-case идентификатор действия (глагол-существительное) или ресурсно-ориентированная операция.
  - Примеры: `create-export`, `get-status`, `sync-contacts`, `refresh-token`.

### 3.3 Идентификаторы ресурсов и детерминизм
- Для идемпотентного создания/обновления без хранения предпочтительны детерминированные ID:
  - Пример: `PUT /api/v1/{businessFlow}/{tool}/exports/{deterministicId}`
- Используйте `409 CONFLICT` для дубликатов с различающимися данными.

### 3.4 Длительные операции
- Старт: `POST /api/v1/{businessFlow}/{tool}/{action}` → `202 Accepted` с `jobId`.
- Поллинг: `GET /api/v1/{businessFlow}/{tool}/jobs/{jobId}` → статус.
- Скачивание (если применимо): `GET /api/v1/{businessFlow}/{tool}/jobs/{jobId}/download`.

### 3.5 Правила именования
- Используйте kebab-case для всех сегментов пути, кроме версии.
- Сегменты должны быть короткими и осмысленными; избегайте внутренних ID в `businessFlow/tool`.
- Дополнительные вложенные сегменты используйте только при необходимости для ресурсов:
  - Пример: `/api/v1/{businessFlow}/{tool}/resources/{resourceId}`.
- Не используйте camelCase, snake_case или PascalCase в сегментах пути.

## 4. Стандартный формат ответов и ошибок

### 4.1 Структура ответа с ошибкой
Все ошибки должны возвращаться в едином формате JSON и содержать заголовок `X-Request-Id` со значением из входящего запроса. Ошибки следуют единому формату ответов, описанному в разделе 4.6:

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Человекочитаемое сообщение об ошибке",
    "details": {
      // Дополнительная информация об ошибке (опционально)
    }
  },
  "meta": {
    // Метаданные (опционально)
    "requestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890" // Значение из заголовка X-Request-Id входящего запроса
  }
}
```

### 4.2 Коды ошибок и обязательные поля
- **Формат кода**: `SNAKE_CASE_ERROR_CODE` — уникальный идентификатор типа ошибки.
- **Сообщение**: краткое описание проблемы на английском языке, подходящее для отображения пользователю.
- **Детали**: структурированная информация для отладки или дополнительный контекст (опционально).
- **meta.requestId**: значение из заголовка `X-Request-Id` входящего запроса (обязательное поле в объекте meta).

### 4.3 Стандартные коды ошибок

| HTTP статус | Код ошибки | Описание |
|------------|------------|----------|
| 400 | `BAD_REQUEST` | Неверный формат запроса или параметры |
| 401 | `UNAUTHORIZED` | Отсутствует или неверный токен аутентификации |
| 403 | `FORBIDDEN` | Недостаточно прав для выполнения операции |
| 404 | `NOT_FOUND` | Запрашиваемый ресурс не найден |
| 409 | `CONFLICT` | Конфликт состояния или идентификатора |
| 412 | `PRECONDITION_FAILED` | Нарушено предусловие (ETag/If-Match) |
| 422 | `VALIDATION_ERROR` | Ошибка валидации данных |
| 429 | `RATE_LIMITED` | Превышены лимиты запросов |
| 500 | `INTERNAL_ERROR` | Внутренняя ошибка сервера |
| 502 | `UPSTREAM_ERROR` | Ошибка внешней зависимости |

### 4.4 Детализация ошибок валидации
Для ошибок валидации (422) рекомендуется включать детали по каждому невалидному полю:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": {
      "fields": [
        {
          "field": "email",
          "code": "INVALID_FORMAT",
          "message": "Invalid email format"
        },
        {
          "field": "age",
          "code": "VALUE_TOO_LOW",
          "message": "Age must be at least 18"
        }
      ]
    }
  },
  "meta": {
    "processingTimeMs": 12
  },
  "requestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}
```

### 4.5 Единый формат ответов
Все ответы API должны следовать единому формату с опциональными полями `data`, `error` и обязательным полем `meta`:

```json
{
  "data": { /* Данные ответа при успешном запросе */ },
  "error": { /* Информация об ошибке при неуспешном запросе */ },
  "meta": { 
    /* Метаданные, например, информация о пагинации */
    "requestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890" // Обязательное поле
  }
}
```

#### 4.5.1 Правила использования полей

- **data**: (опциональное) Присутствует только при успешном запросе. Содержит основные данные ответа.
- **error**: (опциональное) Присутствует только при ошибке. Содержит информацию об ошибке в формате, описанном в разделе 4.1 и 4.2.
- **meta**: (обязательное) Присутствует во всех ответах. Содержит метаданные, включая обязательное поле `requestId` (значение из заголовка `X-Request-Id` входящего запроса).

#### 4.5.2 Примеры ответов

**Успешный ответ с данными:**
```json
{
  "data": {
    "userId": 12345,
    "firstName": "John",
    "lastName": "Doe",
    "email": "john.doe@example.com"
  },
  "meta": {
    "processingTimeMs": 45,
    "requestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  }
}
```

**Успешный ответ со списком и пагинацией:**
```json
{
  "data": [
    {
      "userId": 12345,
      "firstName": "John",
      "lastName": "Doe"
    },
    {
      "userId": 12346,
      "firstName": "Jane",
      "lastName": "Smith"
    }
  ],
  "meta": {
    "pagination": {
      "totalItems": 42,
      "itemsPerPage": 10,
      "currentPage": 1,
      "nextPageToken": "eyJsYXN0SWQiOjEyMzQ2fQ=="
    },
    "requestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  }
}
```

**Ответ с ошибкой:**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Validation failed",
    "details": {
      "fields": [
        {
          "field": "email",
          "code": "INVALID_FORMAT",
          "message": "Invalid email format"
        }
      ]
    }
  },
  "meta": {
    "processingTimeMs": 12,
    "requestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
  }
}
```

### 4.6 Правила именования полей в JSON

#### 4.6.1 Формат именования полей
- **Все поля в ответах должны быть в формате pascalCase**.
- Первая буква каждого поля должна быть в нижнем регистре, а первая буква каждого последующего слова — в верхнем.
- Не используйте подчеркивания, дефисы или другие разделители в именах полей.

#### 4.6.2 Примеры правильного именования

```json
{
  "userId": 12345,
  "firstName": "John",
  "lastName": "Doe",
  "emailAddress": "john.doe@example.com",
  "createdAt": "2023-01-15T14:30:00Z",
  "isActive": true,
  "accountDetails": {
    "accountType": "premium",
    "subscriptionEndDate": "2024-01-15T00:00:00Z"
  }
}
```

#### 4.6.3 Примеры неправильного именования

```json
{
  "UserID": 12345,           // Неверно: PascalCase вместо pascalCase
  "first_name": "John",     // Неверно: snake_case
  "last-name": "Doe",       // Неверно: kebab-case
  "EMAIL_ADDRESS": "john.doe@example.com" // Неверно: UPPER_SNAKE_CASE
}
```

#### 4.6.4 Специальные случаи
- Акронимы длиной более 2 символов должны следовать общему правилу pascalCase: `htmlContent`, `jsonData`, `apiVersion`.
- Двухбуквенные акронимы могут быть в нижнем регистре: `id`, `ui`.
- Идентификаторы сущностей должны иметь суффикс `Id`: `userId`, `orderId`, `productId`.

## 16. Чеклист для PR (контракты)
- **Документация**: описаны эндпоинты, параметры, примеры, схемы.
- **Версионирование/Путь**: соответствует `/api/v{major}/{businessFlow}/{tool}/{action}`; все сегменты в kebab-case; указана целевая версия (`v1`/`v2`).
- **Совместимость**: нет breaking‑изменений в текущей major.
- **Именование полей**: все поля в JSON в формате pascalCase.
- **Ошибки**: корректные статусы и структура ошибки.
- **Пагинация**: cursor‑based, ограничены `limit`/`max`.
- **Безопасность**: нет секретов/PII в ответах и логах; лимиты размера.
- **Наблюдаемость**: прокидывается `X-Request-Id` в заголовках и поле `meta.requestId` в теле ответа.


# comments: English only
# Copy this file to .env and adjust values as needed

# App
PORT=4001
NODE_ENV=development
LOG_DIR=./logs

# Redis
REDIS_URL=redis://127.0.0.1:6379
CACHE_TTL_SEC=604800

# Bull Queue Job Results & Storage Cleanup
# How long to keep completed/failed job results (seconds)
# Applies to:
# - Bull queue job data in Redis
# - Job storage directories (storage/jobs/*)
# - Log files (logs/*.log)
# Cleanup runs daily at 3 AM
# Default: 86400 (24 hours)
JOB_RESULTS_TTL_SEC=86400

# Browser (headful Chrome with persistent profile; watcher controls lifecycle)
BROWSER_URL=http://127.0.0.1:9222
ATTACH_EXISTING=1
USER_DATA_DIR=/data/chrome-profile
PROFILE_DIRECTORY=Default
# Set explicit Chrome executable path if auto-detection fails (optional)
CHROME_EXECUTABLE=
AUTO_REPAIR_BROWSER=1
HEADFUL=1
HEADLESS=0
# Note: NO --guest flag, persistent profile for login session
# First run: manual login via noVNC (port 3000) required

# Queue (single-threaded processing enforced in code; keep for visibility)
QUEUE_NAME=validation
# Concurrency is fixed to 1 in code; do not change

# Worker Configuration
# Number of browser workers to run (1-20)
# Uncomment COMPOSE_PROFILES based on desired worker count:
# - For 1 worker:  leave COMPOSE_PROFILES commented or empty
# - For 2 workers:  COMPOSE_PROFILES=worker2
# - For 3 workers:  COMPOSE_PROFILES=worker2,worker3
# - For 4 workers:  COMPOSE_PROFILES=worker2,worker3,worker4
# - For 5 workers:  COMPOSE_PROFILES=worker2,worker3,worker4,worker5
# - For 10 workers: COMPOSE_PROFILES=worker2,worker3,worker4,worker5,worker6,worker7,worker8,worker9,worker10
# - For 15 workers: COMPOSE_PROFILES=worker2,worker3,worker4,worker5,worker6,worker7,worker8,worker9,worker10,worker11,worker12,worker13,worker14,worker15
# - For 20 workers: COMPOSE_PROFILES=worker2,worker3,worker4,worker5,worker6,worker7,worker8,worker9,worker10,worker11,worker12,worker13,worker14,worker15,worker16,worker17,worker18,worker19,worker20
#COMPOSE_PROFILES=worker2,worker3,worker4,worker5,worker6,worker7,worker8,worker9,worker10,worker11,worker12,worker13,worker14,worker15,worker16,worker17,worker18,worker19,worker20

# Proxy Coordinator URL (for centralized proxy rotation management)
COORDINATOR_URL=http://proxy-coordinator:4200

# Worker URLs (REQUIRED - adjust based on active workers)
# Must match COMPOSE_PROFILES setting above
# Examples:
# 1 worker:   WORKER_BASE_URLS=http://browser-worker:4101
# 2 workers:  WORKER_BASE_URLS=http://browser-worker:4101,http://browser-worker-2:4101
# 5 workers:  WORKER_BASE_URLS=http://browser-worker:4101,http://browser-worker-2:4101,http://browser-worker-3:4101,http://browser-worker-4:4101,http://browser-worker-5:4101
# 10 workers: WORKER_BASE_URLS=http://browser-worker:4101,http://browser-worker-2:4101,http://browser-worker-3:4101,http://browser-worker-4:4101,http://browser-worker-5:4101,http://browser-worker-6:4101,http://browser-worker-7:4101,http://browser-worker-8:4101,http://browser-worker-9:4101,http://browser-worker-10:4101
# Default: 1 worker
WORKER_BASE_URLS=http://browser-worker:4101

# Reverse proxy / TLS (Nginx template variables)
# DOMAIN can be a DNS name (production) or localhost (development)
DOMAIN=eg.instagingserver.com

# External TLS ports exposed by Nginx
API_PORT=4001
NOVNC_PORT=3000
WATCHER_PORT=3101

# Paths to TLS certificate files inside the Nginx container
# For localhost with self-signed or mkcert, set absolute paths inside container, e.g.
# CERT_FULLCHAIN=/etc/letsencrypt/live/localhost/fullchain.pem
# CERT_PRIVKEY=/etc/letsencrypt/live/localhost/privkey.pem
CERT_FULLCHAIN=
CERT_PRIVKEY=

#############################################
# Centralized timeouts (milliseconds)
#############################################

# Worker HTTP timeouts (API -> browser-worker)
# Health check timeout
WORKER_HEALTH_TIMEOUT_MS=7000
# Search request timeout (increase to 90000-120000 for slow responses)
WORKER_SEARCH_TIMEOUT_MS=30000
# Session refresh timeout
WORKER_REFRESH_TIMEOUT_MS=15000
# Browser restart timeout
WORKER_RESTART_TIMEOUT_MS=15000
# Warmup (create/open search tab) timeout
WORKER_WARMUP_TIMEOUT_MS=20000

# Bull queue job timeouts
# Single search job timeout
BULL_SEARCH_TIMEOUT_MS=60000
# Bulk job timeout (1 hour default)
BULL_BULK_TIMEOUT_MS=3600000

# Worker Retry and Resilience Configuration
# Maximum number of quick retry rounds before entering recovery wait mode
RETRY_MAX_ATTEMPTS=3
# Initial delay between retry rounds (exponential backoff starts here)
RETRY_INITIAL_DELAY_MS=1000
# Maximum delay between retry rounds (exponential backoff cap)
RETRY_MAX_DELAY_MS=30000
# Maximum time to wait for worker recovery (default: 5 minutes)
# If all workers are unhealthy, system will wait up to this duration
# before marking the request as failed. Set to 0 to disable waiting.
RETRY_WAIT_FOR_WORKER_MAX_MS=300000
# Interval for proactive worker health checks during recovery wait
RETRY_HEALTH_CHECK_INTERVAL_MS=5000

# Python Worker Timeout Configuration (seconds)
PY_PAGE_TIMEOUT_SEC=45
PY_ANSWER_TIMEOUT_SEC=20
PY_AI_READY_TIMEOUT_SEC=25
PY_AI_READY_TIMEOUT_PER_SEARCH_SEC=8
PY_SEARCH_PAGE_OPEN_TIMEOUT_SEC=12
PY_NEW_SEARCH_BUTTON_WAIT_SEC=3
PY_QUIT_TIMEOUT_SEC=5

#############################################
# Proxy Configuration (Browser Workers)
#############################################

# Proxy Pool (comma-separated list)
# Format: user:pass@host:port,user:pass@host:port
# Scheme (http://) is added automatically if not specified
# Example with IPRoyal residential proxies (sticky sessions):
#PROXY_LIST=customer-user-country-US-session-s1:password@us.iproyal.net:12321,customer-user-country-DE-session-s2:password@de.iproyal.net:12321,customer-user-country-GB-session-s3:password@gb.iproyal.net:12321

# Single proxy fallback (used if PROXY_LIST is empty)
# Format: user:pass@host:port or http://user:pass@host:port
#PROXY_URL=customer-user:password@proxy.example.com:12321

# Proxy binding mode
# - independent: proxy rotates independently from profile (default)
# - by_profile: each profile always uses the same proxy (proxy_idx = profile_idx % len(PROXY_LIST))
PROXY_BINDING_MODE=independent

# Proxy rotation interval (automatic rotation every N requests)
# Set to 0 to disable automatic rotation (default)
# Example: PROXY_ROTATION_REQUESTS=100 - rotate proxy every 100 requests
# Requires: PROXY_LIST with at least 2 proxies
PROXY_ROTATION_REQUESTS=100

# Proxy block timeout (seconds)
# How long to keep proxy marked as blocked before allowing reuse
# Default: 3600 seconds (60 minutes)
# When proxy is blocked, it's marked in Redis with TTL
# All workers will skip this proxy until TTL expires
PROXY_BLOCK_TIMEOUT_SEC=3600

# Chrome Profiles (comma-separated list of paths)
# Each worker needs multiple profiles for rotation
# Recommended: 3-10 profiles per worker for optimal rotation
# Default if not set: ~/.ai_mode_chrome_c,~/.ai_mode_chrome_d
#PY_WORKER_PROFILES=/data/profiles/a,/data/profiles/b,/data/profiles/c,/data/profiles/d,/data/profiles/e

# Session rotation policy
# SESSION_PER_SEARCH=1: create new session for each search (slower but cleaner)
# SESSION_PER_SEARCH=0: reuse session, rotate after MAX_SEARCHES_PER_SESSION (default)
SESSION_PER_SEARCH=0
MAX_SEARCHES_PER_SESSION=50

# Undetected ChromeDriver (experimental anti-detection)
# USE_UC=1: enable undetected-chromedriver (may help with some blocks)
# USE_UC=0: use standard Selenium ChromeDriver (default, more stable)
USE_UC=0

#############################################
# Proxy Rotation Logic
#############################################
# Two types of blocks are detected automatically:
#
# 1. Profile Block (cookies/session blocked)
#    - Triggers: captcha, "unusual traffic" on page
#    - Action: rotate_profile_only() - changes profile, keeps proxy
#
# 2. Proxy Block (IP blocked)
#    - Trigger: "Something went wrong..." in AI response
#    - Action: rotate_proxy_only() + rotate_profile_only() - changes BOTH
#
# No manual configuration needed - logic is hardcoded based on block type
